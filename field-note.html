<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Note — Scott Bertrand</title>
    <meta name="description" content="A working archive of systems, drafts, and field observations.">

    <link rel="canonical" href="https://notes.scottbertrand.com/">

    <!-- Open Graph -->
    <meta property="og:title" content="Field Note — Scott Bertrand">
    <meta property="og:description" content="A working archive of systems, drafts, and field observations.">
    <meta property="og:image" content="https://notes.scottbertrand.com/assets/og-image.png">
    <meta property="og:url" content="https://notes.scottbertrand.com/">
    <meta property="og:type" content="article">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Field Note — Scott Bertrand">
    <meta name="twitter:description" content="A working archive of systems, drafts, and field observations.">
    <meta name="twitter:image" content="https://notes.scottbertrand.com/assets/og-image.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./assets/sb-dotted-logomark.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Stylesheet -->
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="./field-notes.css">
    <link rel="stylesheet" href="./nav-v3.css">
</head>
<body>
    <!-- V3 Glass Navigation -->
    <header class="header visible lights-on">
        <div class="header__glass">
            <div class="header__inner">
                <a href="https://scottbertrand.com/" class="header__logo">
                    <img src="./assets/sb-dotted-logomark.png" alt="SB" class="header__logo-mark sb-monogram" width="50" height="32">
                    <span class="header__logo-divider">|</span>
                    <span class="header__logo-text">Scott Bertrand</span>
                </a>
                <nav class="header__nav">
                    <a href="https://scottbertrand.com/#design-studio" class="header__link header__link--primary header__link--ghosted">
                        Bertrand Brands
                        <span class="header__link-soon">Coming Soon</span>
                    </a>
                    <a href="https://scottbertrand.com/#ventures" class="header__link">Ventures</a>
                    <a href="https://scottbertrand.com/#contact" class="header__link">Contact</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="field-note-entry">
        <div class="container">
            <!-- Back link -->
            <nav class="entry-breadcrumb">
                <a href="/" class="back-link">← Field Notes</a>
            </nav>

            <!-- Entry Header -->
            <header class="entry-header">
                <div class="entry-meta">
                    <span id="entryType" class="entry-type"></span>
                    <span id="entryStatus" class="entry-status"></span>
                </div>

                <h1 id="entryTitle" class="entry-title">Loading...</h1>

                <div id="entryFocus" class="entry-focus"></div>

                <div class="entry-dates">
                    <time id="entryCreated"></time>
                    <span id="entryRevisited"></span>
                </div>
            </header>

            <!-- Entry Content -->
            <article id="entryContent" class="entry-content">
                <!-- Skeleton loader for content -->
                <div class="skeleton skeleton-title" style="height: 24px; margin-bottom: 1.5rem;"></div>
                <div class="skeleton skeleton-focus" style="height: 18px; width: 80%; margin-bottom: 1.5rem;"></div>
                <div class="skeleton skeleton-focus" style="height: 18px; width: 90%; margin-bottom: 1.5rem;"></div>
                <div class="skeleton skeleton-focus" style="height: 18px; width: 70%; margin-bottom: 2rem;"></div>
                <div class="skeleton skeleton-title" style="height: 24px; width: 50%; margin-bottom: 1rem;"></div>
                <div class="skeleton skeleton-focus" style="height: 18px; width: 85%; margin-bottom: 1.5rem;"></div>
                <div class="skeleton skeleton-focus" style="height: 18px; width: 95%; margin-bottom: 1.5rem;"></div>
            </article>
        </div>
    </main>

    <!-- Max Stewart Modal -->
    <div class="modal" id="maxStewartModal" aria-hidden="true">
        <div class="modal-overlay" data-close-modal></div>
        <div class="modal-content">
            <button class="modal-close" data-close-modal aria-label="Close">×</button>
            <img src="./assets/maxstewart-dark.png" alt="Max Stewart" class="modal-image" id="maxStewartModalImage" width="2100" height="434">
            <p class="modal-description">A lifestyle brand exploring recipes, home, and everyday craft.</p>
            <p class="modal-caption">COMING SOON</p>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="./theme.js"></script>
    <script type="module" src="./dropdown.js"></script>
    <script type="module" src="./modal.js"></script>
    <script type="module">
        // Get entry ID from URL path
        const pathParts = window.location.pathname.split('/');
        const entryId = pathParts[pathParts.length - 1].replace('.html', '');

        // Fetch and render entry
        async function loadEntry() {
            try {
                const response = await fetch(`/api/field-notes/${entryId}`);

                // Handle 404 specifically
                if (response.status === 404) {
                    showError('Entry Not Found', 'This field note doesn\'t exist or may have been removed.', false);
                    return;
                }

                const entry = await response.json();

                if (!response.ok) {
                    throw new Error(entry.error || 'Failed to load entry');
                }

                // Update meta
                document.title = `${entry.title} — Field Notes — Scott Bertrand`;

                // Update header
                if (entry.type) {
                    document.getElementById('entryType').textContent = entry.type;
                } else {
                    document.getElementById('entryType').style.display = 'none';
                }

                if (entry.status && entry.status !== 'Working') {
                    document.getElementById('entryStatus').textContent = entry.status;
                } else {
                    document.getElementById('entryStatus').style.display = 'none';
                }

                document.getElementById('entryTitle').textContent = entry.title;

                // Focus tags
                const focusContainer = document.getElementById('entryFocus');
                if (entry.focus.length > 0) {
                    focusContainer.innerHTML = entry.focus.map(f =>
                        `<span class="focus-tag">${f}</span>`
                    ).join('');
                } else {
                    focusContainer.style.display = 'none';
                }

                // Dates
                document.getElementById('entryCreated').textContent = formatDate(entry.created);
                document.getElementById('entryCreated').setAttribute('datetime', entry.created);

                if (entry.revisited) {
                    document.getElementById('entryRevisited').innerHTML =
                        ` · Revisited ${formatDate(entry.revisited)}`;
                }

                // Render content blocks
                const contentContainer = document.getElementById('entryContent');
                let contentHtml = '';

                // Render media image if present (from Files & media property)
                if (entry.media) {
                    contentHtml += `
                        <figure class="entry-image entry-media">
                            <img src="${entry.media}" alt="${entry.title}" loading="lazy">
                        </figure>
                    `;
                }

                // Render content blocks
                contentHtml += renderBlocks(entry.blocks);
                contentContainer.innerHTML = contentHtml;

            } catch (error) {
                console.error('Error loading entry:', error);
                showError('Error Loading Entry', 'Unable to load this entry. Please try again.', true, error.message);
            }
        }

        function showError(title, message, showRetry = true, detail = null) {
            document.getElementById('entryTitle').textContent = title;
            document.getElementById('entryType').style.display = 'none';
            document.getElementById('entryStatus').style.display = 'none';
            document.getElementById('entryFocus').style.display = 'none';
            document.getElementById('entryCreated').style.display = 'none';
            document.getElementById('entryRevisited').style.display = 'none';

            let errorHtml = `
                <div class="error-state">
                    <p>${message}</p>
                    ${detail ? `<p class="error-detail">${detail}</p>` : ''}
                    <div class="error-actions">
                        ${showRetry ? '<button onclick="location.reload()" class="retry-button">Try Again</button>' : ''}
                        <a href="/" class="back-link">← Back to Field Notes</a>
                    </div>
                </div>
            `;
            document.getElementById('entryContent').innerHTML = errorHtml;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function renderBlocks(blocks) {
            return blocks.map(block => {
                switch (block.type) {
                    case 'paragraph':
                        return renderParagraph(block);
                    case 'heading_1':
                        return renderHeading(block, 1);
                    case 'heading_2':
                        return renderHeading(block, 2);
                    case 'heading_3':
                        return renderHeading(block, 3);
                    case 'bulleted_list_item':
                        return renderListItem(block, 'ul');
                    case 'numbered_list_item':
                        return renderListItem(block, 'ol');
                    case 'quote':
                        return renderQuote(block);
                    case 'code':
                        return renderCode(block);
                    case 'divider':
                        return '<hr class="divider">';
                    case 'image':
                        return renderImage(block);
                    default:
                        return `<!-- Unsupported block type: ${block.type} -->`;
                }
            }).join('');
        }

        function getRichText(richTextArray) {
            if (!richTextArray || richTextArray.length === 0) return '';

            return richTextArray.map(text => {
                let content = text.plain_text;

                if (text.annotations.bold) content = `<strong>${content}</strong>`;
                if (text.annotations.italic) content = `<em>${content}</em>`;
                if (text.annotations.code) content = `<code>${content}</code>`;
                if (text.href) content = `<a href="${text.href}" target="_blank" rel="noopener">${content}</a>`;

                return content;
            }).join('');
        }

        function renderParagraph(block) {
            const text = getRichText(block.paragraph.rich_text);
            return text ? `<p>${text}</p>` : '';
        }

        function renderHeading(block, level) {
            const text = getRichText(block[`heading_${level}`].rich_text);
            return `<h${level + 1}>${text}</h${level + 1}>`;
        }

        function renderListItem(block, listType) {
            const text = getRichText(block[block.type].rich_text);
            return `<li>${text}</li>`;
        }

        function renderQuote(block) {
            const text = getRichText(block.quote.rich_text);
            return `<blockquote>${text}</blockquote>`;
        }

        function renderCode(block) {
            const code = block.code.rich_text.map(t => t.plain_text).join('');
            const language = block.code.language;
            return `<pre><code class="language-${language}">${escapeHtml(code)}</code></pre>`;
        }

        function renderImage(block) {
            const imageUrl = block.image.file?.url || block.image.external?.url;
            const caption = getRichText(block.image.caption);
            return `
                <figure class="entry-image">
                    <img src="${imageUrl}" alt="${caption || ''}" loading="lazy">
                    ${caption ? `<figcaption>${caption}</figcaption>` : ''}
                </figure>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load entry on page load
        loadEntry();
    </script>
    <script type="module" src="/src/scripts/visitor-notify.js"></script>
    <script src="./nav-v3.js"></script>
</body>
</html>
